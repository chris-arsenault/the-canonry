{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "era.schema.json",
  "title": "Era",
  "description": "An era configuration defining a historical period in world generation",
  "type": "object",
  "required": ["id", "name", "summary", "templateWeights", "systemModifiers"],
  "properties": {
    "id": { "type": "string", "description": "Unique identifier for this era" },
    "name": { "type": "string", "description": "Human-readable name" },
    "summary": { "type": "string", "description": "User-entered summary of this historical period" },
    "templateWeights": {
      "type": "object",
      "additionalProperties": { "type": "number" },
      "description": "Weights for templates (0 = disabled, 2 = double chance)"
    },
    "systemModifiers": {
      "type": "object",
      "additionalProperties": { "type": "number" },
      "description": "Multipliers for system effects"
    },
    "pressureModifiers": {
      "type": "object",
      "additionalProperties": { "type": "number" },
      "description": "Multipliers for pressure effects"
    },
    "exitConditions": {
      "type": "array",
      "items": { "$ref": "#/$defs/Condition" },
      "description": "Criteria for this era to END (all must be met)"
    },
    "entryConditions": {
      "type": "array",
      "items": { "$ref": "#/$defs/Condition" },
      "description": "Criteria for this era to START (all must be met)"
    },
    "nextEra": {
      "type": "string",
      "description": "Optional explicit next era ID"
    },
    "exitEffects": {
      "$ref": "#/$defs/EraTransitionEffects",
      "description": "Effects applied when transitioning OUT of this era"
    },
    "entryEffects": {
      "$ref": "#/$defs/EraTransitionEffects",
      "description": "Effects applied when transitioning INTO this era"
    }
  },
  "$defs": {
    "NonEmptyString": { "type": "string", "minLength": 1 },
    "AnyOrString": {
      "type": "string",
      "minLength": 1,
      "description": "Either the literal 'any' (meaning match all) or a specific non-empty value"
    },
    "Prominence": { "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"] },

    "SelectionFilter": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "entities"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "exclude" },
            "entities": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["src", "dst", "both"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tags" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "not_has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "matches_culture" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "not_matches_culture" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "status"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_status" },
            "status": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "minProminence"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_prominence" },
            "minProminence": { "$ref": "#/$defs/Prominence" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationshipKind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "shares_related" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "assert"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "graph_path" },
            "assert": { "$ref": "#/$defs/GraphPathAssertion" }
          }
        }
      ]
    },

    "Condition": {
      "oneOf": [
        { "$ref": "#/$defs/PressureCondition" },
        { "$ref": "#/$defs/PressureAnyAboveCondition" },
        { "$ref": "#/$defs/PressureCompareCondition" },
        { "$ref": "#/$defs/EntityCountCondition" },
        { "$ref": "#/$defs/RelationshipCountCondition" },
        { "$ref": "#/$defs/RelationshipExistsCondition" },
        { "$ref": "#/$defs/TagExistsCondition" },
        { "$ref": "#/$defs/LacksTagCondition" },
        { "$ref": "#/$defs/StatusCondition" },
        { "$ref": "#/$defs/ProminenceCondition" },
        { "$ref": "#/$defs/TimeElapsedCondition" },
        { "$ref": "#/$defs/EraMatchCondition" },
        { "$ref": "#/$defs/RandomChanceCondition" },
        { "$ref": "#/$defs/CooldownElapsedCondition" },
        { "$ref": "#/$defs/CreationsPerEpochCondition" },
        { "$ref": "#/$defs/GrowthPhasesCompleteCondition" },
        { "$ref": "#/$defs/GraphPathCondition" },
        { "$ref": "#/$defs/EntityExistsCondition" },
        { "$ref": "#/$defs/EntityHasRelationshipCondition" },
        { "$ref": "#/$defs/CompositeCondition" },
        { "$ref": "#/$defs/AlwaysCondition" }
      ]
    },

    "PressureCondition": {
      "type": "object",
      "required": ["type", "pressureId"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure" },
        "pressureId": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "number", "minimum": -100, "maximum": 100 },
        "max": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureAnyAboveCondition": {
      "type": "object",
      "required": ["type", "pressureIds", "threshold"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_any_above" },
        "pressureIds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "threshold": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureCompareCondition": {
      "type": "object",
      "required": ["type", "pressureA", "pressureB"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_compare" },
        "pressureA": { "$ref": "#/$defs/NonEmptyString" },
        "pressureB": { "$ref": "#/$defs/NonEmptyString" },
        "operator": { "enum": [">", "<", ">=", "<=", "==", "!=" ] }
      }
    },

    "EntityCountCondition": {
      "type": "object",
      "required": ["type", "kind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "integer", "minimum": 0 },
        "max": { "type": "integer", "minimum": 0 },
        "overshootFactor": { "type": "number", "minimum": 1 }
      }
    },

    "RelationshipCountCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "relationship_count" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] },
        "min": { "type": "integer", "minimum": 0 },
        "max": { "type": "integer", "minimum": 0 }
      }
    },

    "RelationshipExistsCondition": {
      "type": "object",
      "required": ["type", "relationshipKind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "relationship_exists" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "with": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] },
        "targetKind": { "$ref": "#/$defs/NonEmptyString" },
        "targetSubtype": { "$ref": "#/$defs/NonEmptyString" },
        "targetStatus": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "TagExistsCondition": {
      "type": "object",
      "required": ["type", "tag"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "tag_exists" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "tag": { "$ref": "#/$defs/NonEmptyString" },
        "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
      }
    },

    "LacksTagCondition": {
      "type": "object",
      "required": ["type", "tag"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "lacks_tag" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "tag": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "StatusCondition": {
      "type": "object",
      "required": ["type", "status"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "status" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "not": { "type": "boolean" }
      }
    },

    "ProminenceCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "prominence" },
        "min": { "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"] },
        "max": { "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"] }
      }
    },

    "TimeElapsedCondition": {
      "type": "object",
      "required": ["type", "minTicks"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "time_elapsed" },
        "minTicks": { "type": "integer", "minimum": 0 },
        "since": { "enum": ["created", "updated"] }
      }
    },

    "EraMatchCondition": {
      "type": "object",
      "required": ["type", "eras"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "era_match" },
        "eras": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
      }
    },

    "RandomChanceCondition": {
      "type": "object",
      "required": ["type", "chance"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "random_chance" },
        "chance": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "CooldownElapsedCondition": {
      "type": "object",
      "required": ["type", "cooldownTicks"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "cooldown_elapsed" },
        "cooldownTicks": { "type": "integer", "minimum": 0 }
      }
    },

    "CreationsPerEpochCondition": {
      "type": "object",
      "required": ["type", "maxPerEpoch"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "creations_per_epoch" },
        "maxPerEpoch": { "type": "integer", "minimum": 0 }
      }
    },

    "GrowthPhasesCompleteCondition": {
      "type": "object",
      "required": ["type", "minPhases"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "growth_phases_complete" },
        "minPhases": { "type": "integer", "minimum": 0 },
        "eraId": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "GraphPathCondition": {
      "type": "object",
      "required": ["type", "assert"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "graph_path" },
        "assert": { "$ref": "#/$defs/GraphPathAssertion" }
      }
    },

    "EntityExistsCondition": {
      "type": "object",
      "required": ["type", "entity"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_exists" },
        "entity": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "EntityHasRelationshipCondition": {
      "type": "object",
      "required": ["type", "entity", "relationshipKind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_has_relationship" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] }
      }
    },

    "CompositeCondition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "conditions"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "and" },
            "conditions": { "type": "array", "items": { "$ref": "#/$defs/Condition" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "conditions"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "or" },
            "conditions": { "type": "array", "items": { "$ref": "#/$defs/Condition" }, "minItems": 1 }
          }
        }
      ]
    },

    "AlwaysCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "always" }
      }
    },

    "GraphPathAssertion": {
      "type": "object",
      "required": ["check", "path"],
      "additionalProperties": false,
      "properties": {
        "check": { "enum": ["exists", "not_exists", "count_min", "count_max"] },
        "path": { "type": "array", "items": { "$ref": "#/$defs/PathStep" }, "minItems": 1 },
        "count": { "type": "integer", "minimum": 0 },
        "where": { "type": "array", "items": { "$ref": "#/$defs/PathConstraint" } }
      }
    },

    "PathStep": {
      "type": "object",
      "required": ["via", "direction", "targetKind", "targetSubtype"],
      "additionalProperties": false,
      "properties": {
        "via": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["out", "in", "any"] },
        "targetKind": { "$ref": "#/$defs/AnyOrString" },
        "targetSubtype": { "$ref": "#/$defs/AnyOrString" },
        "targetStatus": { "$ref": "#/$defs/AnyOrString" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "as": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "PathConstraint": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_self" } }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": { "type": { "const": "kind_equals" }, "kind": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "subtype"],
          "additionalProperties": false,
          "properties": { "type": { "const": "subtype_equals" }, "subtype": { "$ref": "#/$defs/NonEmptyString" } }
        }
      ]
    },

    "ModifyPressureMutation": {
      "type": "object",
      "required": ["type", "pressureId", "delta"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "modify_pressure" },
        "pressureId": { "$ref": "#/$defs/NonEmptyString" },
        "delta": { "type": "number" }
      }
    },

    "EraTransitionEffects": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mutations": {
          "type": "array",
          "items": { "$ref": "#/$defs/ModifyPressureMutation" },
          "description": "Mutations to apply during transition"
        }
      }
    }
  }
}
