{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "generator.schema.json",
  "title": "DeclarativeTemplate",
  "description": "A declarative template/generator definition for world generation",
  "type": "object",
  "required": ["id", "name", "applicability", "selection", "creation", "relationships", "stateUpdates"],
  "additionalProperties": false,
  "properties": {
    "id": { "type": "string", "minLength": 1, "description": "Unique identifier for this generator" },
    "name": { "type": "string", "minLength": 1, "description": "Human-readable name" },
    "narrationTemplate": { "type": "string", "description": "Template for in-world narration. Variables: {$target.field}, {$entityRef.field}, {field|fallback}" },
    "enabled": { "type": "boolean", "description": "Whether this generator is active (default: true)" },
    "applicability": {
      "type": "array",
      "description": "Rules that determine when this template can run",
      "items": { "$ref": "#/$defs/ApplicabilityRule" }
    },
    "selection": { "$ref": "#/$defs/SelectionRule", "description": "How to find target entities" },
    "creation": { "type": "array", "description": "Entities to create", "items": { "$ref": "#/$defs/CreationRule" } },
    "relationships": { "type": "array", "description": "Relationships to form", "items": { "$ref": "#/$defs/RelationshipRule" } },
    "stateUpdates": { "type": "array", "description": "State updates to apply", "items": { "$ref": "#/$defs/StateUpdateRule" } },
    "variables": { "type": "object", "description": "Named entity references computed during execution", "additionalProperties": { "$ref": "#/$defs/VariableDefinition" } },
    "variants": { "$ref": "#/$defs/TemplateVariants", "description": "Conditional variants that modify template output based on world state" }
  },
  "$defs": {
    "NonEmptyString": { "type": "string", "minLength": 1 },
    "AnyOrString": {
      "type": "string",
      "minLength": 1,
      "description": "Either the literal 'any' (meaning match all) or a specific non-empty value"
    },

    "ApplicabilityRule": { "$ref": "#/$defs/Condition" },

    "Condition": {
      "oneOf": [
        { "$ref": "#/$defs/PressureThresholdRule" },
        { "$ref": "#/$defs/PressureAnyAboveRule" },
        { "$ref": "#/$defs/PressureCompareRule" },
        { "$ref": "#/$defs/EntityCountCondition" },
        { "$ref": "#/$defs/RelationshipCountCondition" },
        { "$ref": "#/$defs/RelationshipExistsCondition" },
        { "$ref": "#/$defs/TagExistsCondition" },
        { "$ref": "#/$defs/LacksTagCondition" },
        { "$ref": "#/$defs/StatusCondition" },
        { "$ref": "#/$defs/ProminenceCondition" },
        { "$ref": "#/$defs/TimeElapsedCondition" },
        { "$ref": "#/$defs/EraMatchRule" },
        { "$ref": "#/$defs/RandomChanceRule" },
        { "$ref": "#/$defs/CooldownElapsedRule" },
        { "$ref": "#/$defs/CreationsPerEpochRule" },
        { "$ref": "#/$defs/GrowthPhasesCompleteRule" },
        { "$ref": "#/$defs/GraphPathCondition" },
        { "$ref": "#/$defs/EntityExistsCondition" },
        { "$ref": "#/$defs/EntityHasRelationshipCondition" },
        { "$ref": "#/$defs/CompositeApplicabilityRule" },
        { "$ref": "#/$defs/AlwaysCondition" }
      ]
    },

    "PressureThresholdRule": {
      "type": "object",
      "required": ["type", "pressureId"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure" },
        "pressureId": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "number", "minimum": -100, "maximum": 100 },
        "max": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureAnyAboveRule": {
      "type": "object",
      "required": ["type", "pressureIds", "threshold"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_any_above" },
        "pressureIds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "threshold": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureCompareRule": {
      "type": "object",
      "required": ["type", "pressureA", "pressureB"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_compare" },
        "pressureA": { "$ref": "#/$defs/NonEmptyString" },
        "pressureB": { "$ref": "#/$defs/NonEmptyString" },
        "operator": { "enum": [">", "<", ">=", "<=", "==", "!="] }
      }
    },

    "EntityCountMinRule": {
      "type": "object",
      "required": ["type", "kind", "min"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "integer", "minimum": 0 }
      }
    },

    "EntityCountMaxRule": {
      "type": "object",
      "required": ["type", "kind", "max"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "max": { "type": "integer", "minimum": 0 },
        "overshootFactor": { "type": "number", "minimum": 1 }
      }
    },

    "EntityCountCondition": {
      "type": "object",
      "required": ["type", "kind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "integer", "minimum": 0 },
        "max": { "type": "integer", "minimum": 0 },
        "overshootFactor": { "type": "number", "minimum": 1 }
      }
    },

    "EraMatchRule": {
      "type": "object",
      "required": ["type", "eras"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "era_match" },
        "eras": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
      }
    },

    "RandomChanceRule": {
      "type": "object",
      "required": ["type", "chance"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "random_chance" },
        "chance": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "CooldownElapsedRule": {
      "type": "object",
      "required": ["type", "cooldownTicks"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "cooldown_elapsed" },
        "cooldownTicks": { "type": "integer", "minimum": 1 }
      }
    },

    "CreationsPerEpochRule": {
      "type": "object",
      "required": ["type", "maxPerEpoch"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "creations_per_epoch" },
        "maxPerEpoch": { "type": "integer", "minimum": 1 }
      }
    },

    "GrowthPhasesCompleteRule": {
      "type": "object",
      "required": ["type", "minPhases"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "growth_phases_complete" },
        "minPhases": { "type": "integer", "minimum": 0 },
        "eraId": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "CompositeApplicabilityRule": {
      "type": "object",
      "required": ["type", "conditions"],
      "additionalProperties": false,
      "properties": {
        "type": { "enum": ["and", "or"] },
        "conditions": { "type": "array", "items": { "$ref": "#/$defs/Condition" }, "minItems": 1 }
      }
    },

    "AlwaysCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "always" }
      }
    },

    "RelationshipCountCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "relationship_count" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] },
        "min": { "type": "integer", "minimum": 0 },
        "max": { "type": "integer", "minimum": 0 }
      }
    },

    "RelationshipExistsCondition": {
      "type": "object",
      "required": ["type", "relationshipKind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "relationship_exists" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "with": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] },
        "targetKind": { "$ref": "#/$defs/NonEmptyString" },
        "targetSubtype": { "$ref": "#/$defs/NonEmptyString" },
        "targetStatus": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "TagExistsCondition": {
      "type": "object",
      "required": ["type", "tag"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "tag_exists" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "tag": { "$ref": "#/$defs/NonEmptyString" },
        "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
      }
    },

    "LacksTagCondition": {
      "type": "object",
      "required": ["type", "tag"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "lacks_tag" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "tag": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "StatusCondition": {
      "type": "object",
      "required": ["type", "status"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "status" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "not": { "type": "boolean" }
      }
    },

    "ProminenceCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "prominence" },
        "min": { "$ref": "#/$defs/NonEmptyString" },
        "max": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "TimeElapsedCondition": {
      "type": "object",
      "required": ["type", "minTicks"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "time_elapsed" },
        "minTicks": { "type": "integer", "minimum": 0 },
        "since": { "enum": ["created", "updated"] }
      }
    },

    "GraphPathCondition": {
      "type": "object",
      "required": ["type", "assert"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "graph_path" },
        "assert": { "$ref": "#/$defs/GraphPathAssertion" }
      }
    },

    "EntityExistsCondition": {
      "type": "object",
      "required": ["type", "entity"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_exists" },
        "entity": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "EntityHasRelationshipCondition": {
      "type": "object",
      "required": ["type", "entity", "relationshipKind"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_has_relationship" },
        "entity": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] }
      }
    },

    "GraphPathAssertion": {
      "type": "object",
      "required": ["check", "path"],
      "additionalProperties": false,
      "properties": {
        "check": { "enum": ["exists", "not_exists", "count_min", "count_max"] },
        "path": { "type": "array", "items": { "$ref": "#/$defs/PathStep" }, "minItems": 1 },
        "count": { "type": "integer", "minimum": 0 },
        "where": { "type": "array", "items": { "$ref": "#/$defs/PathConstraint" } }
      }
    },

    "PathStep": {
      "type": "object",
      "required": ["via", "direction", "targetKind", "targetSubtype"],
      "additionalProperties": false,
      "properties": {
        "via": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["out", "in", "any"] },
        "targetKind": { "$ref": "#/$defs/AnyOrString" },
        "targetSubtype": { "$ref": "#/$defs/AnyOrString" },
        "targetStatus": { "$ref": "#/$defs/AnyOrString" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "as": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "PathConstraint": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_self" } }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": { "type": { "const": "kind_equals" }, "kind": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "subtype"],
          "additionalProperties": false,
          "properties": { "type": { "const": "subtype_equals" }, "subtype": { "$ref": "#/$defs/NonEmptyString" } }
        }
      ]
    },

    "SaturationLimit": {
      "type": "object",
      "required": ["relationshipKind", "maxCount"],
      "additionalProperties": false,
      "properties": {
        "relationshipKind": {
          "$ref": "#/$defs/NonEmptyString",
          "description": "The relationship kind to count"
        },
        "direction": {
          "enum": ["src", "dst", "both", "out", "in"],
          "description": "Direction: 'src'/'dst'/'both' or 'out'/'in' (default: both)"
        },
        "fromKind": {
          "$ref": "#/$defs/NonEmptyString",
          "description": "Optional: only count relationships from/to this entity kind"
        },
        "fromSubtype": {
          "$ref": "#/$defs/NonEmptyString",
          "description": "Optional: only count relationships from/to this entity subtype (requires fromKind)"
        },
        "maxCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of relationships allowed (target is selected only if count < maxCount)"
        }
      }
    },

    "SelectionRule": {
      "type": "object",
      "required": ["strategy"],
      "additionalProperties": false,
      "properties": {
        "strategy": { "enum": ["by_kind", "by_preference_order", "by_relationship", "by_proximity", "by_prominence"] },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "kinds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "subtypes": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "excludeSubtypes": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "statuses": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "notStatus": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "mustHave": { "type": "boolean" },
        "direction": { "enum": ["src", "dst", "both"] },
        "subtypePreferences": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "referenceEntity": { "$ref": "#/$defs/NonEmptyString" },
        "maxDistance": { "type": "number", "minimum": 0 },
        "minProminence": { "$ref": "#/$defs/Prominence" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "saturationLimits": {
          "type": "array",
          "items": { "$ref": "#/$defs/SaturationLimit" },
          "description": "Limit target selection to entities that haven't exceeded relationship counts"
        },
        "pickStrategy": { "enum": ["random", "first", "all", "weighted"] },
        "maxResults": { "type": "integer", "minimum": 1 }
      },
      "anyOf": [
        { "required": ["kind"] },
        { "required": ["kinds"] }
      ]
    },

    "SelectionFilter": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "entities"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "exclude" },
            "entities": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["src", "dst", "both"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tags" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "not_has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "matches_culture" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "status"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_status" },
            "status": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "minProminence"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_prominence" },
            "minProminence": { "$ref": "#/$defs/Prominence" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationshipKind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "shares_related" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "assert"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "graph_path" },
            "assert": { "$ref": "#/$defs/GraphPathAssertion" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationshipKinds"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "component_size" },
            "relationshipKinds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
            "min": { "type": "integer", "minimum": 1 },
            "max": { "type": "integer", "minimum": 1 },
            "minStrength": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        }
      ]
    },

    "CreationRule": {
      "type": "object",
      "required": ["entityRef", "kind", "subtype", "status", "prominence", "culture", "placement"],
      "additionalProperties": false,
      "properties": {
        "entityRef": { "$ref": "#/$defs/NonEmptyString", "description": "Variable name for this entity (e.g., $newFaction)" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/SubtypeSpec" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "prominence": { "$ref": "#/$defs/Prominence" },
        "culture": { "$ref": "#/$defs/CultureSpec" },
        "description": { "$ref": "#/$defs/DescriptionSpec" },
        "tags": { "type": "object", "additionalProperties": { "type": "boolean" } },
        "placement": { "$ref": "#/$defs/PlacementSpec" },
        "count": { "oneOf": [{ "type": "integer", "minimum": 1 }, { "$ref": "#/$defs/CountRange" }] },
        "createChance": { "type": "number", "minimum": 0, "maximum": 1, "description": "Optional creation chance (0.0 to 1.0). If specified, entity is only created with given probability. Useful for cross-pollination." }
      }
    },

    "SubtypeSpec": {
      "oneOf": [
        { "$ref": "#/$defs/NonEmptyString" },
        {
          "type": "object",
          "required": ["inherit"],
          "additionalProperties": false,
          "properties": {
            "inherit": { "$ref": "#/$defs/NonEmptyString" },
            "chance": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        {
          "type": "object",
          "required": ["fromPressure"],
          "additionalProperties": false,
          "properties": {
            "fromPressure": { "type": "object", "additionalProperties": { "$ref": "#/$defs/NonEmptyString" }, "minProperties": 1 }
          }
        },
        {
          "type": "object",
          "required": ["random"],
          "additionalProperties": false,
          "properties": {
            "random": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["conditional"],
          "additionalProperties": false,
          "properties": {
            "conditional": {
              "type": "object",
              "required": ["when", "otherwise"],
              "additionalProperties": false,
              "properties": {
                "when": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["condition", "then"],
                    "additionalProperties": false,
                    "properties": {
                      "condition": { "$ref": "#/$defs/SubtypeCondition" },
                      "then": { "$ref": "#/$defs/NonEmptyString" }
                    }
                  },
                  "minItems": 1
                },
                "otherwise": { "$ref": "#/$defs/NonEmptyString" }
              }
            }
          }
        }
      ]
    },

    "SubtypeCondition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "equals"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "target_subtype" },
            "equals": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "pressureId"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "pressure_check" },
            "pressureId": { "$ref": "#/$defs/NonEmptyString" },
            "min": { "type": "number" },
            "max": { "type": "number" }
          }
        }
      ]
    },

    "CultureSpec": {
      "oneOf": [
        {
          "type": "object",
          "required": ["inherit"],
          "additionalProperties": false,
          "properties": { "inherit": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["fixed"],
          "additionalProperties": false,
          "properties": { "fixed": { "$ref": "#/$defs/NonEmptyString" } }
        }
      ]
    },

    "DescriptionSpec": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["template", "replacements"],
          "additionalProperties": false,
          "properties": {
            "template": { "$ref": "#/$defs/NonEmptyString" },
            "replacements": { "type": "object", "additionalProperties": { "$ref": "#/$defs/NonEmptyString" }, "minProperties": 1 }
          }
        }
      ]
    },

    "PlacementSpec": {
      "type": "object",
      "required": ["anchor"],
      "additionalProperties": false,
      "properties": {
        "anchor": {
          "oneOf": [
            {
              "type": "object",
              "required": ["type", "ref"],
              "additionalProperties": false,
              "properties": {
                "type": { "const": "entity" },
                "ref": { "$ref": "#/$defs/NonEmptyString" },
                "stickToRegion": { "type": "boolean" }
              }
            },
            {
              "type": "object",
              "required": ["type", "id"],
              "additionalProperties": false,
              "properties": {
                "type": { "const": "culture" },
                "id": { "$ref": "#/$defs/NonEmptyString" }
              }
            },
            {
              "type": "object",
              "required": ["type", "refs"],
              "additionalProperties": false,
              "properties": {
                "type": { "const": "refs_centroid" },
                "refs": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
                "jitter": { "type": "number", "minimum": 0 }
              }
            },
            {
              "type": "object",
              "required": ["type"],
              "additionalProperties": false,
              "properties": {
                "type": { "const": "sparse" },
                "preferPeriphery": { "type": "boolean" }
              }
            },
            {
              "type": "object",
              "required": ["type"],
              "additionalProperties": false,
              "properties": {
                "type": { "const": "bounds" },
                "bounds": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "x": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                    "y": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                    "z": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
                  }
                }
              }
            }
          ]
        },
        "spacing": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "minDistance": { "type": "number", "minimum": 0 },
            "avoidRefs": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" } }
          }
        },
        "regionPolicy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allowEmergent": { "type": "boolean", "description": "Allow emergent region creation when seed regions are at capacity" },
            "createRegion": { "type": "boolean", "description": "Create a new region centered on the placed entity (useful for sparse placement establishing new territories)" },
            "preferSparse": { "type": "boolean", "description": "Bias region selection toward sparser regions (weighted by inverse entity count)" }
          }
        },
        "steps": {
          "type": "array",
          "minItems": 1,
          "items": {
            "enum": ["anchor_region", "seed_region", "sparse", "random"]
          }
        }
      }
    },

    "CountRange": {
      "type": "object",
      "required": ["min", "max"],
      "additionalProperties": false,
      "properties": {
        "min": { "type": "integer", "minimum": 1 },
        "max": { "type": "integer", "minimum": 1 }
      }
    },

    "Prominence": {
      "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"]
    },

    "RelationshipRule": {
      "type": "object",
      "required": ["kind", "src", "dst"],
      "additionalProperties": false,
      "properties": {
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "src": { "$ref": "#/$defs/NonEmptyString" },
        "dst": { "$ref": "#/$defs/NonEmptyString" },
        "strength": { "type": "number", "minimum": 0, "maximum": 1 },
        "bidirectional": { "type": "boolean" },
        "catalyzedBy": { "$ref": "#/$defs/NonEmptyString" },
        "condition": { "$ref": "#/$defs/Condition" }
      }
    },

    "RelationshipCondition": { "$ref": "#/$defs/Condition" },

    "StateUpdateRule": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": { "type": { "const": "update_rate_limit" } }
        },
        {
          "type": "object",
          "required": ["type", "src", "dst", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "create_relationship" },
            "src": { "$ref": "#/$defs/NonEmptyString" },
            "dst": { "$ref": "#/$defs/NonEmptyString" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "strength": { "type": "number", "minimum": 0, "maximum": 1 },
            "bidirectional": { "type": "boolean" },
            "category": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "relationshipKind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "archive_relationship" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString", "description": "Entity reference or 'any' to archive all relationships of this kind" },
            "direction": { "enum": ["src", "dst", "both"], "default": "both", "description": "Which end of the relationship the entity should be on" }
          }
        },
        {
          "type": "object",
          "required": ["type", "pressureId", "delta"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "modify_pressure" },
            "pressureId": { "$ref": "#/$defs/NonEmptyString" },
            "delta": { "type": "number" }
          }
        },
        {
          "type": "object",
          "required": ["type", "src", "dst", "kind", "delta"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "adjust_relationship_strength" },
            "src": { "$ref": "#/$defs/NonEmptyString" },
            "dst": { "$ref": "#/$defs/NonEmptyString" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "delta": { "type": "number" },
            "bidirectional": { "type": "boolean" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "newStatus"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "change_status" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "newStatus": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "delta"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "adjust_prominence" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "delta": { "type": "number", "description": "Amount to adjust prominence by (positive or negative)" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "set_tag" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] },
            "valueFrom": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "remove_tag" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "tag": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationship", "direction", "actions"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "for_each_related" },
            "relationship": { "$ref": "#/$defs/NonEmptyString", "description": "Relationship kind to traverse" },
            "direction": { "enum": ["src", "dst", "both", "in", "out", "any"], "description": "Direction to traverse" },
            "targetKind": { "$ref": "#/$defs/NonEmptyString", "description": "Filter to target kind" },
            "targetSubtype": { "$ref": "#/$defs/NonEmptyString", "description": "Filter to target subtype" },
            "actions": { "type": "array", "items": { "$ref": "#/$defs/StateUpdateRule" }, "description": "Actions to execute for each related entity (binds $related)" }
          }
        }
      ]
    },

    "VariableDefinition": {
      "type": "object",
      "required": ["select"],
      "additionalProperties": false,
      "properties": {
        "select": { "$ref": "#/$defs/VariableSelectionRule" },
        "required": { "type": "boolean", "description": "If true, template won't run unless this variable resolves" }
      }
    },

    "VariableSelectionRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "from": {
          "oneOf": [
            { "$ref": "#/$defs/RelatedEntitiesSpec" },
            { "const": "graph" }
          ]
        },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "kinds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "subtypes": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "statuses": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "notStatus": { "$ref": "#/$defs/NonEmptyString" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "preferFilters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "pickStrategy": { "enum": ["random", "first", "all", "weighted"] },
        "maxResults": { "type": "integer", "minimum": 1 }
      }
    },

    "RelatedEntitiesSpec": {
      "type": "object",
      "required": ["relatedTo", "relationshipKind", "direction"],
      "additionalProperties": false,
      "properties": {
        "relatedTo": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both", "out", "in", "any"] }
      }
    },

    "TemplateVariants": {
      "type": "object",
      "required": ["selection", "options"],
      "additionalProperties": false,
      "properties": {
        "selection": { "enum": ["first_match", "all_matching"] },
        "options": { "type": "array", "items": { "$ref": "#/$defs/TemplateVariant" }, "minItems": 1 }
      }
    },

    "TemplateVariant": {
      "type": "object",
      "required": ["name", "when", "apply"],
      "additionalProperties": false,
      "properties": {
        "name": { "$ref": "#/$defs/NonEmptyString" },
        "when": { "$ref": "#/$defs/VariantCondition" },
        "apply": { "$ref": "#/$defs/VariantEffects" }
      }
    },

    "VariantCondition": {
      "$ref": "#/$defs/Condition"
    },

    "VariantEffects": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "subtype": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/NonEmptyString" },
          "description": "Override subtype for created entities. Key is entityRef (e.g., $location)"
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": "boolean" }
          },
          "description": "Additional tags to add. Key is entityRef, value is tag map"
        },
        "relationships": {
          "type": "array",
          "items": { "$ref": "#/$defs/RelationshipRule" },
          "description": "Additional relationships to create"
        },
        "stateUpdates": {
          "type": "array",
          "items": { "$ref": "#/$defs/StateUpdateRule" },
          "description": "Additional state updates to apply"
        }
      }
    }
  }
}
